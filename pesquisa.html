<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa Avan√ßada | QualVai</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script>
        function initMap() {
            console.log('‚úÖ Google Places API carregada!');
            if (window.onGooglePlacesReady) {
                window.onGooglePlacesReady();
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqWHhpa≈∫dziCKgB7vK3W_tZNNgQxOEYrQs&libraries=places&callback=initMap" async defer></script>
    
    <style>
        :root {
            --primary: #FF4D17;
            --primary-dark: #E03D0F;
            --primary-light: #FF6B3D;
            --navy: #1A0B2E;
            --accent: #FFB800;
            --bg-light: #FFFFFF;
            --bg-gray: #F8F9FA;
            --text-primary: #2D2A3D;
            --text-secondary: #6B6878;
            --text-muted: #9B98A8;
            --border: #E8E7ED;
            --border-light: #F0EFF5;
            --status-open: #10B981;
            --status-closed: #EF4444;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --shadow-xl: 0 12px 48px rgba(0,0,0,0.16);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Inter', sans-serif; color: var(--text-primary); background: var(--bg-light); line-height: 1.6; }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 5%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        .logo-container:hover { transform: scale(1.02); }

        .logo-icon { width: 45px; height: 45px; }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1.2px;
        }

        .logo-text .qual {
            background: linear-gradient(135deg, #3B9DD9 0%, #FF6B35 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text .vai { color: var(--navy); }

        .nav-links { display: flex; align-items: center; gap: 8px; }

        .nav-links a {
            text-decoration: none;
            color: var(--text-secondary);
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover { color: var(--text-primary); background: var(--bg-gray); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white !important;
            padding: 12px 28px !important;
            box-shadow: 0 4px 16px rgba(255, 77, 23, 0.25);
        }

        /* PAGE HEADER */
        .page-header {
            background: linear-gradient(135deg, var(--navy) 0%, #2D1B4E 100%);
            padding: 60px 5% 50px;
            color: white;
            text-align: center;
        }

        .page-header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(36px, 5vw, 52px);
            font-weight: 800;
            margin-bottom: 16px;
            letter-spacing: -1.5px;
        }

        .page-header p {
            font-size: 19px;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }

        /* LAYOUT */
        .search-layout {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 300px);
        }

        /* SIDEBAR */
        .sidebar {
            width: 340px;
            background: white;
            border-right: 1px solid var(--border-light);
            position: sticky;
            top: 89px;
            height: calc(100vh - 89px);
            overflow-y: auto;
            padding: 32px 24px;
        }

        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .sidebar-title {
            font-family: 'Poppins', sans-serif;
            font-size: 24px;
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .sidebar-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .filter-section {
            margin-bottom: 32px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border-light);
        }

        .filter-section:last-child { border-bottom: none; }

        .filter-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .filter-option:hover { background: var(--bg-gray); }

        .filter-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .filter-option label {
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }

        .filter-count {
            font-size: 13px;
            color: var(--text-muted);
            background: var(--bg-gray);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* BOT√ïES */
        .sidebar-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 24px 0 0;
            border-top: 2px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-search {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(255, 77, 23, 0.3);
            transition: all 0.3s ease;
        }

        .btn-search:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 77, 23, 0.4);
        }

        .btn-clear {
            background: white;
            color: var(--text-secondary);
            border: 2px solid var(--border);
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-clear:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* RESULTADOS */
        .results-area {
            flex: 1;
            padding: 48px 40px;
            background: var(--bg-gray);
        }

        /* TAGS ATIVAS */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 32px;
            justify-content: center;
        }

        .filter-tag {
            background: var(--primary);
            color: white;
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-tag-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            transition: transform 0.2s ease;
        }

        .filter-tag-close:hover { transform: scale(1.3); }

        /* HEADER RESULTADOS */
        .results-header {
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 22px;
            font-weight: 800;
            color: var(--navy);
        }

        .results-sort {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-sort label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .results-sort select {
            padding: 12px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            background: white;
        }

        /* GRID */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
            gap: 28px;
        }

        /* CARDS */
        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-light);
            transition: all 0.4s ease;
            cursor: pointer;
        }

        .card.hidden { display: none; }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .card-img-container {
            width: 100%;
            aspect-ratio: 16/10;
            overflow: hidden;
            position: relative;
            background: var(--bg-gray);
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .card:hover .card-img { transform: scale(1.1); }

        .card-badge {
            position: absolute;
            top: 14px;
            right: 14px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            z-index: 2;
        }

        .card-badge.featured {
            background: linear-gradient(135deg, var(--accent) 0%, #FFD93D 100%);
            color: var(--navy);
        }

        .card-badge.kids {
            background: linear-gradient(135deg, #EC4899 0%, #F472B6 100%);
            color: white;
            top: 48px;
        }

        .card-category {
            position: absolute;
            top: 14px;
            left: 14px;
            background: rgba(26, 11, 46, 0.85);
            backdrop-filter: blur(8px);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 2;
        }

        .card-body { padding: 20px; }

        .card-title {
            font-weight: 700;
            font-size: 19px;
            color: var(--navy);
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .card-rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-gray);
            padding: 5px 11px;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .star { color: var(--accent); font-size: 14px; }

        .rating-value {
            font-weight: 700;
            font-size: 13px;
            color: var(--text-primary);
        }

        .rating-qv {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .rating-qv .star { color: white; }
        .rating-qv .rating-value { color: white; }

        .rating-google::after {
            content: 'Google';
            font-size: 9px;
            opacity: 0.7;
            margin-left: 2px;
        }

        .card-location {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
            font-size: 14px;
            margin: 10px 0;
        }

        .card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-open .status-dot { background: var(--status-open); }
        .status-closed .status-dot { background: var(--status-closed); }
        .status-open { color: var(--status-open); }
        .status-closed { color: var(--status-closed); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .card-price {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
        }

        .card-info-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-gray);
            padding: 4px 9px;
            border-radius: 6px;
        }

        .delivery-tag {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            font-weight: 600;
        }

        /* LOADING */
        .loading { text-align: center; padding: 100px 20px; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-small {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 6px;
        }

        /* NO RESULTS */
        .no-results {
            text-align: center;
            padding: 100px 20px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
        }

        .no-results h3 {
            font-size: 26px;
            color: var(--navy);
            margin-bottom: 14px;
        }

        .no-results p {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 28px;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .search-layout { flex-direction: column; }
            .sidebar {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-light);
            }
            .results-area { padding: 32px 20px; }
        }

        @media (max-width: 768px) {
            .page-header h1 { font-size: 30px; }
            .results-header { flex-direction: column; gap: 16px; align-items: flex-start; }
            .results-grid { grid-template-columns: 1fr; }
            .nav-links a:not(.btn-primary) { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo-container">
            <img src="logo-qualvai.png" alt="QualVai" class="logo-icon" onerror="this.style.display='none'">
            <div class="logo-text">
                <span class="qual">Qual</span><span class="vai">Vai</span>
            </div>
        </a>
        <nav class="nav-links">
            <a href="index.html">In√≠cio</a>
            <a href="pesquisa.html" class="btn-primary">Pesquisa Avan√ßada</a>
        </nav>
    </header>

    <section class="page-header">
        <h1>Pesquisa Avan√ßada</h1>
        <p>Use os filtros ao lado para encontrar exatamente o que voc√™ procura</p>
    </section>

    <div class="search-layout">
        
        <aside class="sidebar">
            <h2 class="sidebar-title">Filtros</h2>
            <p class="sidebar-subtitle">Refine sua busca</p>
            
            <div class="filter-section">
                <div class="filter-title">üè™ Tipo de Local</div>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="cat-restaurante" value="restaurante">
                        <label for="cat-restaurante">Restaurantes</label>
                        <span class="filter-count" id="count-restaurante">0</span>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="cat-bar" value="bar">
                        <label for="cat-bar">Bares & Pubs</label>
                        <span class="filter-count" id="count-bar">0</span>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="cat-cafe" value="cafe">
                        <label for="cat-cafe">Caf√©s</label>
                        <span class="filter-count" id="count-cafe">0</span>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="cat-cultura" value="cultura">
                        <label for="cat-cultura">Cultura</label>
                        <span class="filter-count" id="count-cultura">0</span>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="cat-natureza" value="natureza">
                        <label for="cat-natureza">Natureza</label>
                        <span class="filter-count" id="count-natureza">0</span>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="cat-compras" value="compras">
                        <label for="cat-compras">Compras</label>
                        <span class="filter-count" id="count-compras">0</span>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">‚≠ê Caracter√≠sticas</div>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="feat-featured" value="featured">
                        <label for="feat-featured">‚≠ê Em Destaque</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="feat-delivery" value="delivery">
                        <label for="feat-delivery">üõµ Delivery</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="feat-kids" value="kids">
                        <label for="feat-kids">üë∂ √Årea Kids</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="feat-open" value="open">
                        <label for="feat-open">üü¢ Aberto Agora</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">üí≥ Pagamento</div>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="pay-pix" value="pix">
                        <label for="pay-pix">üì± PIX</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="pay-card" value="cart√£o">
                        <label for="pay-card">üí≥ Cart√£o</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="pay-cash" value="dinheiro">
                        <label for="pay-cash">üíµ Dinheiro</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="pay-voucher" value="voucher">
                        <label for="pay-voucher">üé´ Voucher</label>
                    </div>
                </div>
            </div>

            <div class="sidebar-actions">
                <button class="btn-search" id="btnApply">üîç Aplicar Filtros</button>
                <button class="btn-clear" id="btnClear">‚úï Limpar Tudo</button>
            </div>
        </aside>

        <main class="results-area">
            <div class="active-filters" id="activeTags"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Carregando lugares...</p>
            </div>

            <div class="results-header" id="resultsHeader" style="display: none;">
                <div class="results-count" id="resultsCount">0 lugares</div>
                <div class="results-sort">
                    <label for="sortBy">Ordenar:</label>
                    <select id="sortBy">
                        <option value="relevance">Mais Relevantes</option>
                        <option value="rating">Melhor Avaliados</option>
                    </select>
                </div>
            </div>

            <div class="results-grid" id="resultsGrid"></div>

            <div class="no-results" id="noResults" style="display: none;">
                <h3>Nenhum resultado encontrado</h3>
                <p>Tente ajustar os filtros ou limpar a busca</p>
                <button class="btn-clear" onclick="clearAll()">Limpar Filtros</button>
            </div>
        </main>
    </div>

    <script>
        const SHEET_ID = '1tKwZvr27lHo2iV2rR6yxiPqxGgbP517auUOBib1DBcI';
        const SHEET_NAME = 'lugares';
        let placesData = [];
        let filteredData = [];
        let googlePlacesService = null;
        let activeFilters = { categories: [], features: [], payments: [] };

        window.onGooglePlacesReady = function() {
            const div = document.createElement('div');
            googlePlacesService = new google.maps.places.PlacesService(div);
            console.log('‚úÖ Google Places pronto!');
            if (placesData.length > 0) updateGoogleData();
        };

        function fetchGoogleDetails(place, card) {
            if (!place.placeId || !googlePlacesService) return;
            googlePlacesService.getDetails({
                placeId: place.placeId,
                fields: ['rating', 'user_ratings_total', 'opening_hours']
            }, (result, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    if (result.rating) {
                        const ratingEl = card.querySelector('.rating-google .rating-value');
                        if (ratingEl) {
                            const loading = ratingEl.querySelector('.loading-small');
                            if (loading) loading.remove();
                            ratingEl.innerHTML = result.rating.toFixed(1);
                            const count = document.createElement('span');
                            count.style.fontSize = '10px';
                            count.style.opacity = '0.7';
                            count.style.marginLeft = '3px';
                            count.textContent = `(${result.user_ratings_total})`;
                            ratingEl.appendChild(count);
                        }
                    }
                    if (result.opening_hours) {
                        const isOpen = result.opening_hours.isOpen();
                        const statusEl = card.querySelector('.card-status');
                        if (statusEl) {
                            const loading = statusEl.querySelector('.loading-small');
                            if (loading) loading.remove();
                            statusEl.className = `card-status ${isOpen ? 'status-open' : 'status-closed'}`;
                            statusEl.innerHTML = `<span class="status-dot"></span>${isOpen ? 'Aberto agora' : 'Fechado'}`;
                        }
                    }
                }
            });
        }

        function updateGoogleData() {
            if (!googlePlacesService) return;
            document.querySelectorAll('.card[data-placeid]').forEach(card => {
                const placeId = card.dataset.placeid;
                const place = placesData.find(p => p.placeId === placeId);
                if (place) fetchGoogleDetails(place, card);
            });
        }

        function handleSheetData(data) {
            console.log('‚úÖ Dados recebidos!');
            try {
                const rows = data.table.rows;
                placesData = [];
                rows.forEach((row, index) => {
                    const c = row.c;
                    const name = c[0]?.v || c[0]?.f || '';
                    if (!name.trim()) return;
                    placesData.push({
                        id: index,
                        name: name,
                        category: (c[1]?.v || c[1]?.f || 'outros').toLowerCase().trim(),
                        image: c[2]?.v || c[2]?.f || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400',
                        location: c[3]?.v || c[3]?.f || '',
                        distance: c[4]?.v || c[4]?.f || '',
                        price: c[5]?.v || c[5]?.f || '',
                        tags: (c[6]?.v || c[6]?.f || '').split(',').map(t => t.trim()).filter(t => t),
                        featured: (c[7]?.v || c[7]?.f || '').toLowerCase() === 'sim',
                        placeId: c[8]?.v || c[8]?.f || null,
                        rating: parseFloat(c[9]?.v || c[9]?.f || 0),
                        status: (c[10]?.v || c[10]?.f || 'aberto').toLowerCase(),
                        delivery: (c[11]?.v || c[11]?.f || '').toLowerCase() === 'sim',
                        payment: c[12]?.v || c[12]?.f || '',
                        ratingQV: parseFloat(c[13]?.v || c[13]?.f || 0),
                        areaKids: (c[14]?.v || c[14]?.f || '').toLowerCase() === 'sim'
                    });
                });
                placesData.sort((a, b) => {
                    if (a.featured && !b.featured) return -1;
                    if (!a.featured && b.featured) return 1;
                    return 0;
                });
                console.log(`‚úÖ ${placesData.length} lugares!`);
                localStorage.setItem('qualvai_cache', JSON.stringify({ data: placesData, timestamp: Date.now() }));
                updateCounts();
                applyFilters();
                if (googlePlacesService) updateGoogleData();
            } catch (error) {
                console.error('‚ùå Erro:', error);
            }
        }

        function fetchPlacesFromSheet() {
            const script = document.createElement('script');
            script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleSheetData&sheet=${SHEET_NAME}`;
            document.head.appendChild(script);
        }

        function updateCounts() {
            const counts = {};
            placesData.forEach(p => { counts[p.category] = (counts[p.category] || 0) + 1; });
            Object.keys(counts).forEach(cat => {
                const el = document.getElementById(`count-${cat}`);
                if (el) el.textContent = counts[cat];
            });
        }

        function applyFilters() {
            let filtered = [...placesData];
            if (activeFilters.categories.length > 0) {
                filtered = filtered.filter(p => activeFilters.categories.includes(p.category));
            }
            if (activeFilters.features.includes('featured')) {
                filtered = filtered.filter(p => p.featured);
            }
            if (activeFilters.features.includes('delivery')) {
                filtered = filtered.filter(p => p.delivery);
            }
            if (activeFilters.features.includes('kids')) {
                filtered = filtered.filter(p => p.areaKids);
            }
            if (activeFilters.features.includes('open')) {
                filtered = filtered.filter(p => p.status === 'aberto');
            }
            if (activeFilters.payments.length > 0) {
                filtered = filtered.filter(p => {
                    const payment = p.payment.toLowerCase();
                    return activeFilters.payments.some(pay => payment.includes(pay));
                });
            }
            filteredData = filtered;
            renderResults(filtered);
            updateTags();
        }

        function renderResults(places) {
            const grid = document.getElementById('resultsGrid');
            const loading = document.getElementById('loading');
            const header = document.getElementById('resultsHeader');
            const count = document.getElementById('resultsCount');
            const noResults = document.getElementById('noResults');

            grid.innerHTML = '';
            loading.style.display = 'none';

            if (places.length === 0) {
                header.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            header.style.display = 'flex';
            noResults.style.display = 'none';
            count.textContent = `${places.length} lugar${places.length !== 1 ? 'es' : ''}`;

            places.forEach(place => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.id = place.id;
                if (place.placeId) card.dataset.placeid = place.placeId;

                const isOpen = place.status === 'aberto';
                let statusHtml = `<div class="card-status ${isOpen ? 'status-open' : 'status-closed'}"><span class="status-dot"></span>${isOpen ? 'Aberto agora' : 'Fechado'}${place.placeId ? '<span class="loading-small"></span>' : ''}</div>`;

                let deliveryBadge = place.delivery ? '<span class="tag delivery-tag">üõµ Delivery</span>' : '';

                let ratingsHtml = '';
                if (place.ratingQV > 0) {
                    ratingsHtml += `<div class="card-rating rating-qv"><span class="star">‚òÖ</span><span class="rating-value">${place.ratingQV.toFixed(1)}</span></div>`;
                }
                if (place.rating > 0 || place.placeId) {
                    ratingsHtml += `<div class="card-rating rating-google"><span class="star">‚òÖ</span><span class="rating-value">${place.rating > 0 ? place.rating.toFixed(1) : '...'}${place.placeId && place.rating === 0 ? '<span class="loading-small"></span>' : ''}</span></div>`;
                }

                card.innerHTML = `
                    <div class="card-img-container">
                        <span class="card-category">${getCategoryName(place.category)}</span>
                        ${place.featured ? '<span class="card-badge featured">‚≠ê Destaque</span>' : ''}
                        ${place.areaKids ? '<span class="card-badge kids">üë∂ Kids</span>' : ''}
                        <img src="${place.image}" class="card-img" alt="${place.name}" onerror="this.src='https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'">
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${place.name}</h3>
                        <div>${ratingsHtml}</div>
                        <div class="card-location">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                                <path d="M7 0C4.24 0 2 2.24 2 5c0 3.5 5 9 5 9s5-5.5 5-9c0-2.76-2.24-5-5-5zm0 7a2 2 0 110-4 2 2 0 010 4z"/>
                            </svg>
                            ${place.location}${place.distance ? ' ¬∑ ' + place.distance : ''}
                        </div>
                        ${statusHtml}
                        <div class="card-footer">
                            <div class="card-info-tags">
                                ${deliveryBadge}
                                ${place.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                            ${place.price ? `<span class="card-price">${place.price}</span>` : ''}
                        </div>
                    </div>
                `;

                grid.appendChild(card);
                if (place.placeId && googlePlacesService) fetchGoogleDetails(place, card);
            });
        }

        function getCategoryName(cat) {
            const names = { restaurante: 'Restaurante', bar: 'Bar', cafe: 'Caf√©', cultura: 'Cultura', natureza: 'Natureza', compras: 'Compras' };
            return names[cat] || cat.charAt(0).toUpperCase() + cat.slice(1);
        }

        function updateTags() {
            const container = document.getElementById('activeTags');
            container.innerHTML = '';
            const tags = [];

            activeFilters.categories.forEach(cat => {
                tags.push({ label: getCategoryName(cat), type: 'category', value: cat });
            });
            activeFilters.features.forEach(feat => {
                const names = { featured: '‚≠ê Destaque', delivery: 'üõµ Delivery', kids: 'üë∂ Kids', open: 'üü¢ Aberto' };
                tags.push({ label: names[feat], type: 'feature', value: feat });
            });
            activeFilters.payments.forEach(pay => {
                const names = { pix: 'üì± PIX', cart√£o: 'üí≥ Cart√£o', dinheiro: 'üíµ Dinheiro', voucher: 'üé´ Voucher' };
                tags.push({ label: names[pay], type: 'payment', value: pay });
            });

            tags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'filter-tag';
                tagEl.innerHTML = `${tag.label}<button class="filter-tag-close" onclick="removeFilter('${tag.type}', '${tag.value}')">√ó</button>`;
                container.appendChild(tagEl);
            });
        }

        function removeFilter(type, value) {
            switch(type) {
                case 'category':
                    activeFilters.categories = activeFilters.categories.filter(c => c !== value);
                    document.getElementById(`cat-${value}`).checked = false;
                    break;
                case 'feature':
                    activeFilters.features = activeFilters.features.filter(f => f !== value);
                    document.getElementById(`feat-${value}`).checked = false;
                    break;
                case 'payment':
                    activeFilters.payments = activeFilters.payments.filter(p => p !== value);
                    document.getElementById(`pay-${value}`).checked = false;
                    break;
            }
            applyFilters();
        }

        function clearAll() {
            activeFilters = { categories: [], features: [], payments: [] };
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            applyFilters();
        }

        document.getElementById('btnApply').addEventListener('click', () => {
            activeFilters.categories = Array.from(document.querySelectorAll('[id^="cat-"]:checked')).map(cb => cb.value);
            activeFilters.features = Array.from(document.querySelectorAll('[id^="feat-"]:checked')).map(cb => cb.value);
            activeFilters.payments = Array.from(document.querySelectorAll('[id^="pay-"]:checked')).map(cb => cb.value);
            applyFilters();
        });

        document.getElementById('btnClear').addEventListener('click', clearAll);

        document.getElementById('sortBy').addEventListener('change', function() {
            if (this.value === 'rating') {
                filteredData.sort((a, b) => {
                    const ratingA = Math.max(a.rating, a.ratingQV);
                    const ratingB = Math.max(b.rating, b.ratingQV);
                    return ratingB - ratingA;
                });
            } else {
                filteredData.sort((a, b) => {
                    if (a.featured && !b.featured) return -1;
                    if (!a.featured && b.featured) return 1;
                    return 0;
                });
            }
            renderResults(filteredData);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const cache = localStorage.getItem('qualvai_cache');
            if (cache) {
                const cached = JSON.parse(cache);
                if (Date.now() - cached.timestamp < 3600000) {
                    placesData = cached.data;
                    updateCounts();
                    applyFilters();
                    return;
                }
            }
            fetchPlacesFromSheet();
        });
    </script>

</body>
</html>
